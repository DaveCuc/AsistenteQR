<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente para Tomar Asistencia</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #scanButton, #registerButton {
      padding: 15px 30px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
    }
    #cameraView {
      width: 100%;
      max-width: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Bienvenido al asistente para tomar asistencia</h1>
  <button id="scanButton">Escanear QR</button>
  <video id="cameraView" autoplay hidden></video>
  <button id="registerButton" hidden>Registrar</button>

  <!-- Carga de jsQR desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <script>
    const scanButton = document.getElementById('scanButton');
    const registerButton = document.getElementById('registerButton');
    const cameraView = document.getElementById('cameraView');
    
    let qrData = ''; // Variable para almacenar los datos del QR

    // Evento para abrir la c치mara y escanear el QR
    scanButton.addEventListener('click', () => {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then((stream) => {
          cameraView.srcObject = stream;
          cameraView.hidden = false;
          scanButton.hidden = true;

          const scanQR = () => {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = cameraView.videoWidth;
            canvas.height = cameraView.videoHeight;
            context.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
              qrData = code.data; // Almacena los datos del QR escaneado
              stream.getTracks().forEach(track => track.stop()); // Detiene la c치mara
              cameraView.hidden = true;
              registerButton.hidden = false;
            } else {
              requestAnimationFrame(scanQR); // Sigue escaneando hasta encontrar un QR
            }
          };

          requestAnimationFrame(scanQR); // Inicia el proceso de escaneo
        })
        .catch((error) => {
          alert('No se pudo acceder a la c치mara: ' + error);
        });
    });

    // Evento para el bot칩n de registrar
    registerButton.addEventListener('click', () => {
      // URL base de tu Google Apps Script
      const baseUrl = "https://script.google.com/macros/s/AKfycbx-Ug5HcF0lCEcbuDrrhmG7MOrkrpEuu3N0_2cUfI--YuHAx7GPCh3iGBqtjize-1iC2w/exec";
      
      // Construye la URL completa usando el valor del QR
      const fullUrl = `${baseUrl}&${qrData}`;
      
      // Redirige a la URL para registrar la asistencia
      window.location.href = fullUrl;
    });
  </script>
</body>
</html>
